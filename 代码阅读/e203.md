### 4.5 E203处理器的配置选项

配置文件config.v目录：

<img src="C:\WINDOWS\TEMP\WeChat Files\fc85b243eea66fac259cebe273c0009.jpg" alt="fc85b243eea66fac259cebe273c0009" style="zoom: 50%;" />

​		通过改变宏的定义，实现不同的配置，每个宏的含义在书的66页。

```
E203_CFG_PPI_BASE_REGION、E203_CFG_CLINT_BASE_REGION、E203_CFG_PLIC_BASE_REGION和E203_CFG_FIO_BASE_REGION：都是通过指定高位的区间来界定地址区间。例如，高位地址为31：28，可以得到高位地址区间共4位，可以得到共有2<sup>4</sup>=16个不同的地址区间，每个地址区间大小为2<sup>4</sup>=16字节，若基地址为0x1000_0000，则可得到第一个地址区间的起始地址为基地址=0x1000_0000，第二个地址区间的起始地址为0x1000_0010，依次类推得到最后的地址区间为0x1000_0000~0x1FFF_FFFF。
```

### 5.3 E203处理器核的RTL代码风格

#### 5.3.1 使用标准DFF模块例化生成寄存器

​		寄存器是数字同步电路中基本单元，最常见的方式是使用always块生成寄存器，而E203推荐采用模块化的标准DFF模块进行例化实现寄存器。

​		好处：

1. 便于全局替换寄存器类型
2. 便于在寄存器中全局插入延迟
3. 明确的load-enable使能信号可方便综合工具自动插入寄存器级别的门控时钟以降低功耗
4. 便于规避verilog语法中if-else不能传播不定态的问题

标准DFF模块源代码目录：

<img src="C:\WINDOWS\TEMP\WeChat Files\23230d6eba35204a7dc57671c53091c.jpg" alt="23230d6eba35204a7dc57671c53091c" style="zoom: 50%;" />

​		其中D触发器处理lden信号的不定态的方式是使用断言进行捕捉

```verilog
//使用assertion捕捉lden信号的不定态
`ifndef FPGA_SOURCE//{
`ifndef DISABLE_SV_ASSERTION//{
//synopsys translate_off
sirv_gnrl_xchecker # (  //该模块内部是使用SystemVerilog编写的断言
  .DW(1)
) sirv_gnrl_xchecker(
  .i_dat(lden),
  .clk  (clk)
);
//synopsys translate_on
`endif//}
`endif//}
```

![947af1cf192b7da3e10a8fbdaa8d4c6](C:\WINDOWS\TEMP\WeChat Files\947af1cf192b7da3e10a8fbdaa8d4c6.jpg)

#### 5.3.2 使用assign语法替代if-else和case语法

​		verilog中的if-else和case语法存在的缺点：（1）不能传播不定态 （2）会产生优先级的选择电路而非并行选择电路，从而不利于优化时序和面积。

​		故推荐使用assign语句替代。

1. 传播不定态

​		举例如下：假设a为不定态（X），按照Verilog语法会将等效于a = 0，从而out输出为in2，没有将X传播出去

```verilog
if(a)
	out = in1;
else 
	out = in2;
```

​		使用功能等效的assign语法：

```verilog
assign out = a ? in1 :in2 ;
```

> 三目运算符：条件a为不定态X时，输出也为不定态X

2. 产生并行选择电路

​		if-else语法会被综合成优先级选择电路：

```verilog
if(sel1)
    out = in1[3:0];
else if (sel2)
    out = in2[3:0];
else if (sel3)
    out = in3[3:0];
else
    out = 4'b0;
```

​		若此处确实要生成一种优先级选择逻辑，推荐使用assign语法等效，规避X（不定态）传播的问题

```verilog
assign out = sel1 ? in1[3:0] :
    		 sel2 ? in2[3:0] :
    		 sel3 ? in3[3:0] :
    				4'b0;
```

​		若此处要生成一种并行选择逻辑，推荐使用assign语法明确的使用“与或”逻辑

```verilog
assign =  	({4{sel1}} & in1[3:0])
    	  | ({4{sel2}} & in2[3:0])
   		  | ({4{sel3}} & in3[3:0])
```

#### 5.3.3 其他注意事项

- 由于带reset信号的寄存器面积略大，时序稍微差一点，因此在数据通路上可以使用不带reset信号的寄存器，而只在控制通路上使用reset信号的寄存器
- 信号名避免使用拼音，使用英文缩写，代码即注释，从信号名中看出其功能
- Clock和Reset信号禁止用于任何其他的逻辑功能，这两个信号只能接入DFF，作为其时钟和复位信号

#### 5.5 E203处理器核的源代码

![ec42ddebd3b6d5ad21023ad04ce506c](C:\WINDOWS\TEMP\WeChat Files\ec42ddebd3b6d5ad21023ad04ce506c.jpg)

### 6.1 处理器流水线概述

#### 6.1.2 流水线和状态机的关系

- 流水线本质上可以理解为一种以面积换性能、以空间换时间的手段；
- 状态机本质上可以理解为一种以性能换面积、以时间换空间的手段；

​		**单从功能上来讲，处理器完全可以不使用流水线，而只使用状态机实现**，可以省掉流水线中的寄存器开销，还可以复用组合逻辑数据通路，因此面积开销比较小，但性能较差。

#### 6.1.3 流水线的深度

​		流水线级数越多，每一级流水线内容纳的硬件逻辑便越少，在两级寄存器（每一级流水线由寄存器组成）之间的硬件逻辑越少，则处理器能够达到更高的主频。这是流水线加深的正面意义。

​		由于每一级流水线都由寄存器组成，因此更多的流水线级数需要消耗更多的寄存器，占用更多的芯片面积。这是流水线加深的负面意义。

​		由于每一级流水线需要进行握手，流水线最后一级的反压信号可能会一直串扰到最前一级，造成严重的时序问题。这也是流水线加深的负面意义。

​		较深的处理器流水线还有一个问题，即跳转指令的分支预测问题，当预测错误时，流水线深度越深，会浪费更多的功耗和性能。这是流水线加深的另一个主要的负面意义。

#### 6.1.5 越来越浅的流水线

​		2012年发布的Cortex—M0+处理器核的流水线级数只有2，ARM宣传为世界上能效比最高的处理器核。

