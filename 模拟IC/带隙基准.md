### 1，带隙基准原理建模：

带隙基准原理图：                <img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224210128359.png" alt="image-20231224210128359" style="zoom:50%;" />

​		结压降VBE在室温下的温度系数越为-2.0mV/K，而热电压VT在室温下的温度系数为0.085mV/K，将VT乘以常数M并和VBE相加可得到输出电压VREF：<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224210235233.png" alt="image-20231224210235233" style="zoom: 67%;" />，对温度T微分，并在室温下等于零（输出电压在室温下的理论温度系数为零)，可解得常数M的值。

> 理解：可以通过一个负温度系数的电压和一个正温度系数的电压相加得到一个零温度系数的电压。实验发现三极管的结电压与温度成负相关，两个三极管工作在不相同的电流密度下，他们的基极-发射极电压差VBE与温度成正比。

建模测试如下：

- 负温度系数测量

![image-20231224210918376](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224210918376.png)

​		使用pnp2_5三极管，m=1,电流为1uA，对温度进行DC扫描，扫描范围-40~140℃，得到的VA电压如下：

![image-20231224211211558](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224211211558.png)

​		可见随着温度增大，VA减小，斜率为：（495.4786 - 816.1349）/（140 + 40）= - 1.781mV/C，常温27℃下电压值为702.8529mV。

- 正温度系数测量

![image-20231224215301522](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224215301522.png)

​		使用两个pnp2_5三极管，m=1，电流为1uA，得到VA；m=8，电流为1uA，得到VB；对温度进行DC扫描，扫描范围-40~140℃，得到的VA-VB电压如下：

![image-20231224215502130](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224215502130.png)

​		可见随着温度增大，VA-VB增大，斜率为：（74.22678 - 42.09486）/（140 + 40）= 178.51 uV/C，常温27℃下电压值为 54.1037 mV。

> 可以看到这两条温度曲线一个向上，一个向下，只不过两者的斜率略有不同，如果我们将正温度系数的电压扩大一个系数1.781/0.17851=9.977，再与负温度相加，理论上正负就抵消了，得到了一个想要的带隙基准电压，并且可以计算一下这个电压在常温下的值约为54.1037mV*9.977+702.8529mV=1242.65mV

- 带隙基准模型仿真

​		已经得到了负温度系数和正温度系数，随后将正温度系数乘以倍数K，再相加，可得到输出带隙基准电压。

![image-20231224222817462](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224222817462.png)

​		用一个VCVS实现了扩大倍数并相加的功能，对温度进行DC扫描，扫描范围-40~140℃，得到的Vout电压如下：

![image-20231224224545614](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224224545614.png)

​		其中Vref在整个温度变化范围内的偏差为6.896mV，换算成ppm为30.83ppm。

> VCVS：<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224224722913.png" alt="image-20231224224722913" style="zoom:33%;" />，<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224224741630.png" alt="image-20231224224741630" style="zoom:67%;" />

>ppm单位换算：<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231224225446969.png" alt="image-20231224225446969" style="zoom: 33%;" />

### 2，带隙基准仿真

> 这里使用.18的库进行设计仿真

- 使用理想运放进行带隙基准的仿真

​		可以看到VREF随温度的误差变化大概在7mV左右，那么我希望由运放增益不足导致的误差应当远小于7mV，假设为十分之一，那么就是700uV。如图，该VREF上的误差等效到运放的输入端还有一个电阻的倍数关系，最后折合到运放的输入端，约为70uV。

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231225005323240.png" alt="image-20231225005323240" style="zoom: 33%;" />

​		假设电路稳定之后运放的输出为1V，误差目标为小于70uV，那么需要的增益为Av=1V/70uV，换算成dB为83.1dB。

​		这里使用VCVS替代理想运放进行带隙基准的仿真，其中的VCVS的增益为3000倍。

![image-20231226013921198](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226013921198.png)

​		其中的电阻R1：<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226012422781.png" alt="image-20231226012422781" style="zoom:50%;" />

计算电阻R2：

​		根据上面的方式测量PNP管在10uA条件下的温度特性曲线可得：1，负温度系数斜率 - 1.583 mV/℃；27℃条件下为764.621mV；2，正温度系数斜率 0.1793 mV/℃；27℃条件下为55.924mV；

输出基准电压计算可得：1.583/0.1793 * 55.924 + 764.621 = 1258.36 mV

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226012922026.png" alt="image-20231226012922026" style="zoom:50%;" />

最终电路：

随后对温度进行DC扫描，范围为 -40~140℃。

发现输出电压的温度特性曲线不太正确，随后对R2的电阻值进行扫描，最终确定R2 = 43.5K

测得的输出电压的温度特性曲线为：

![image-20231226013224857](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226013224857.png)

​		输出基准电压为1258.36 mV，其中Vref在整个温度变化范围内的偏差为2.88mV，换算成ppm为12.7ppm。

- 使用实际运放进行带隙基准的仿真

选用一个差分放大器作为运放：<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231225152416637.png" alt="image-20231225152416637" style="zoom:33%;" />

​		使用gmid方法进行尺寸的设计：

> [gm/Id的模拟电路设计方法（5）——两级OTA设计 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/338239944)

运放设计仿真图：各个尺寸如图所示

![image-20231226021935630](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226021935630.png)

运放测试电路：

![image-20231226021915301](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226021915301.png)

运放的环路增益与相位裕度如下：

![image-20231226021655138](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226021655138.png)

​		低频增益为50.6dB，相位裕度为48.7°，带宽为16.93MHz。

​		将原先带隙基准电路中的理想运放进行替换，可得：

![image-20231226020733373](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226020733373.png)

对其进行DC温度扫描，温度范围为- 40 ~ 140℃：

![image-20231226020843528](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226020843528.png)

​		输出基准电压为1258.36 mV，其中Vref在整个温度变化范围内的偏差为3.5mV，换算成ppm为15.45ppm，27℃下输出电压为1.208V。

### 3，带隙基准其他参数仿真

- PSRR

​		在输入VDD上增加一个1V的交流量，随后进行AC仿真观察输出

![image-20231226022719993](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226022719993.png)

​		可见对于高频的电压抑制较差，最简单的方式可在输出端串联一个低通RC滤波进行改善。

- 环路增益与相位裕度

​		在运放的输出端添加iprobe，进行stb仿真。

![image-20231226023954760](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226023954760.png)

![image-20231226023146780](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226023146780.png)

​		低频环路增益为49dB，相位裕度为52.9°，带宽为3.37MHz。

- 上电启动瞬态仿真

​		输入一个1.8V电压，启动时间为1us，输出电压波形如下：

![image-20231226023912830](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226023912830.png)

​		启动时间为1us，输出电压波形如下：

![image-20231226024408323](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226024408323.png)

​		正常工作。

- 输入电压范围：

​		对输入电压进行DC扫描，范围为0~5V

![image-20231226133148428](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226133148428.png)

​		输入电压大于1.5V时输出电压工作正常1.20627V，输入4V时输出电压为1.201V。

### 4，输出电压大小调整

​		思路是通过使用运放，将1.2V电压提升至1.4V；

- 先使用一个理想运放（这里使用VCVS替代）构成的反向比例放大器进行仿真：

![image-20231226155310150](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226155310150.png)

​		可见输出电压可以提升至1.4V，但输出电压的性能肯定会变差，对于输出电压的精度，稳定性，PSRR等指标会有影响。

- 使用五管运放进行反向比例放大仿真：

​		根据运放的输入电压和VDD的大小决定使用NMOS管输入的五管运放：

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226174638391.png" alt="image-20231226174638391" style="zoom: 50%;" />

​		经过仿真可知，使用这种方式的确可以使输出达到1.4V，但随着供电电压VDD改变，输出电压在不断变化，且偏差太大：

![image-20231226200405873](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20231226200405873.png)

​		故此种方式不可行。



### 5，输出电流大小调整



### 6，启动电路
