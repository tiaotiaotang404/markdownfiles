# RISC-V指令集架构研究综述

### 1，前言

​		现代信息系统的设计新趋势：(1)注重软硬件协同；(2)面向需求的系统定制化。

​		指令集架构（ISA）作为软件与硬件之间的交互规范，定义了软硬件的组合或整合方式，根据新的发展趋势，目前需要一种新的指令集，既满足软硬件的深度协同融合和灵活组合，又具备开放性。

​		RISC-V是一种新的开源指令集架构，加州大学伯克利分校2010年首次发布。一方面，它规定了硬件设备在设计电路、组装元件时应当实现的功能目标；另一方面它是对硬件能力的一种抽象，提供了机器所能完成的操作种类、地址空间大小、数据格式、访问权限信息；上层软件应用可以将指令集视为硬件运行环境，而无需特别关注具体的硬件实体。

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230629095545632.png" alt="image-20230629095545632" style="zoom:50%;" />

> 理解：指令集就相当于把硬件电路给封装起来了，对于在这个架构上进行软件开发的设计师就当硬件是一个黑匣子，无需关心硬件具体的电路，只用关心黑匣子的接口即可，把软件和硬件的开发给隔离开了，提高了开发的效率。

​		对于RISC-V的研究有四个层面：

- 对于底层RISC-V硬件的研究
- 对于RISC-V指令集自身的研究
- 对于上层RISC-V系统（主要是基础软件）的研究
- 对于顶层应用的研究

​		在每个层面的研究内容上，普遍集中在系统或应用的功能、性能、安全三方面。

​		此文章主要内容就是围绕上述四个层面和三方面两个维度展开总结。

***

### 2，RISC-V指令集

​		RISC-V的指令集包括基础指令集和扩展指令集两类。

​		**RISC-V指令集架构被定义为一个基础指令集和若干可选指令集的组合，并在一种权限模式下进行工作。**

#### 2.1, RISC-V基础指令集(5种)

- RVWMO(弱内存次序指令集);

- RV32I(32位整数指令集);

- RV64I(64位整数指令集);

- RV32E(32位嵌入式整数指令集);

- RV128I(128位整数指令集)

##### 2.1.1 RV32I和RV64I指令集

​		两者都使用32个通用寄存器(x寄存器)和一个额外的非特权寄存器(pc寄存器)，区别在于位宽(XLEN)，RV32I是32位,RV64I中是64位。其中x0寄存器所有位被硬布线为0，不可更改，因此称为零寄存器，pc寄存器又称为程序计数器，用于保存当前指令的地址。

> 对于零寄存器的理解：汇编代码中，经常会遇到大量的跟0比较/赋值成0的场景，设计一个专用寄存器可以加速执行常用操作，简化指令系统体系结构，例如数据传送指令正好可以被视作一个操作数为0的加法；使用零减去原数以求原数的相反数；还有与零比大小等等操作。

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230629104949914.png" alt="image-20230629104949914" style="zoom:50%;" />

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230629105012285.png" alt="image-20230629105012285" style="zoom: 50%;" />

​		RV32I有4种基础指令格式：R/I/S/U，指令都是32位固定长度，并且必须在内存中对齐到四字节的边界。

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230629105336745.png" alt="image-20230629105336745" style="zoom: 33%;" />

​		RV64I采用与RV32I相同的指令格式，只是将整数寄存器和所支持的用户地址空间扩展到了64位，增加了一些操作低32位的“*W”指令（如ADDIW，即将加法后得到的32位结果符号扩展至64位）。

##### 2.1.2，RV32E指令集

​		RV32E是专为嵌入式环境设计的指令集，是对RV32I的一种简化，它与RV32I唯一的区别在于将可用的整数寄存器数目从32减少到了16，即只用x0~x15和pc完成所有的指令功能。

<img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230629105931191.png" alt="image-20230629105931191" style="zoom: 50%;" />

​		RV32E的标准调用约定与RV32I 的并不兼容，RISC-V规范提供了一种专用于RV32E的调用约定ILP32E，它要求栈指针对齐只能到32位边界，在寄存器的分配上采取与RV32I一致的分配方案。

> 指令集的调用约定：是规定子过程如何获取参数以及如何返回的方案，其通常与架构、编译器等相关。
>
> 具体来说，调用约定一般规定了：
>
> - 参数、返回值、返回地址等放置的位置（寄存器、栈或存储器等）
> - 如何将调用子过程的准备工作与恢复现场的工作划分到调用者（Caller）与被调用者（Callee）身上
>
> 调用约定是不同人编写的汇编程序能正常配合工作的保证。
>
> [调用约定（Calling Convention）浅析 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/111028312)
>
> [(29条消息) x86/x64/arm32/arm64/riscv等平台上的调用约定_x64 arm32 arm64_defrag257的博客-CSDN博客](https://blog.csdn.net/defrag257/article/details/120286771)

> 理解：调用约定就是规定了函数调用时候涉及到的参数和地址的获取、保存、恢复等操作

##### 2.1.3，RV128I指令集

​		RV128I是对RV32I和RV64I的直接外扩，仅仅把整数寄存器扩展到了128位，此外，RV128I保留了RV64I中用于操作低32位的"*W”指令，只是将结果从32位扩展至128位；

​		RV128I新增了用于操作低64位的“*D”指令。

##### 2.1.4，RVWMO指令集

​		RVWMO指令集定义了RISC-V的内存一致性模型。内存一致性模型是一组规则的集合，指定了内存的load操作所能返回的结果。RVWMO内存模型属于弱内存次序的，即在一个多线线程程序有多种不同可能的执行，而每种执行有其自己的相应的全局内存次序。这里的“全局内存次序”是指所有硬件线程所产生的内存操作的总体次序。

> 这里的内存一致性模型，弱内存次序都是针对多线程的，硬件上的概念

> 内存一致性模型（Memory Consistency Model）就是用来描述多线程对共享存储器的访问行为，在不同的内存一致性模型里，多线程对共享存储器的访问行为有非常大的差别。
>
> [(29条消息) 浅析内存屏障：内存一致性模型_Aspiresky的博客-CSDN博客](https://blog.csdn.net/anyegongjuezjd/article/details/125954805)
>
> [C++ 内存模型与顺序一致性 - 明明1109 - 博客园 (cnblogs.com)](https://www.cnblogs.com/fortunely/p/16739327.html)
>
> [理解弱内存顺序模型 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/94421667)

> 内存一致性模型理解：内存一致性模型就是为了让多线程的CPU与存储单元更快更好的进行数据的交互的一组规则，共四种，其中的顺序是指程序顺序和处理器的执行顺序，两者相同就是顺序，不同就是乱序
>
> <img src="C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230630102839757.png" alt="image-20230630102839757" style="zoom:50%;" />
>
> 从上到下对于指令的限制由强到弱，可以通过增加内存屏障以解决在这些一致性模型上可能出现的内存乱序访问问题，内存屏障的最根本的作用就是提供一个机制，要求CPU在这个时候必须以顺序存储一致性模型的方式来处理Store与Load指令，这样才不会出现内存访问不一致的情况

> 强弱内存次序理解：如果处理器的执行顺序与代码声明顺序相同，内存模型为**强顺序的**；如果处理器的执行顺序与代码声明顺序不同，内存模型为**弱顺序的**
>
> 弱顺序的内存模型，可以使得处理器进一步提升并行性，从而提升程序性能，但出错的概率大一些，需要加入内存屏障减小出错的概率
>
> [Cache的基本原理 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/102293437)

​		内存模型原语、各指令的依存句法和保留的程序次序，以及基于这些内容的3条公理（加载值公理、原子性公理、进度公理），共同构成了RVWMO内存一致性模型。

#### 2.2，RISC-V扩展指令集

​		现有的扩展指令集共有24种。列举几个：

1. 乘法和除法扩展（M扩展）：用于将两个整数寄存器中的值进行相乘或相除，具体包含了MUL、DIV、REM等指令及对应于无符号数操作或64位操作相关的各种变体指令。
2. 原子指令扩展（A扩展）：用于支持相同内存空间中的多个硬件线程间的同步，主要包含了对内存进行原子性读取、修改、写入的指令。
3. 单精度浮点扩展（F扩展）：用于支持单精度浮点运算，添加了兼容IEEE754-2008算数标准的单精度浮点运算指令，以及32个32位宽的浮点寄存器f0~f31，和一个浮点控制与状态寄存器fcsr。
4. 双精度浮点扩展（D扩展）
5. 四精度浮点扩展（Q扩展）
6. 位操作扩展（B扩展）

#### 2.3，RISC-V指令集的状态

![image-20230629144329527](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230629144329527.png)

#### 2.4，RISC-V权限模式

​		共四种：

- 机器模式（Machine，M模式）
- 用户模式（User，U模式）
- 管理模式（Supervisor，S模式）
- 监视模式（Hypervisor，H模式）（草案）

​		RISC-V通过CSR来控制当前的权限模式，通过设置CSR中特定两位的值，可切换到不同模式。

![image-20230629144749903](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230629144749903.png)

##### 2.4.1，M模式

​		**机器模式是RISC-V指令集架构中最高级别的权限模式，具有执行任何机器操作的权限，也是在系统设计中必须被实现的一个工作模式。**相比较之下，其他权限模式都是可选的，不同的系统可以根据运行环境和实际需要决定实现某一级别的权限模式。

##### 2.4.2，U模式

​		**用户模式是RISC-V特权系统中最低级别的权限模式**，又称为“非特权模式”，通常用于执行来自用户等外部环境的不可信操作，通过对其操作范围的限制来保护系统内的各种资源不受侵害。

##### 2.4.3，S模式

​		管理模式具有比用户级更高的操作权限，可以用于操作一台机器中的敏感资源，**RISC-V管理模式需要与机器模式和用户模式共同实现。因此，不能出现系统中只存在S模式而不存在U模式的情况。**

##### 2.4.4，H模式

​		监视模式可用于管理跨机器的资源，或者将机器整体作为组件承担更高级别的任务。

---

### 3，RISC-V硬件平台

​		RISC-V依托的硬件平台可以含有如下组件：

1. 带有其他非兼容RISC-V核心的一个或多个兼容RISC-V的处理核心
2. 固定功能加速器——这里加速器是指一种不可编程的固定功能单元或者专用于特定任务的核心
3. 各种物理内存结构
4. I/O设备
5. 组件通信与交互结构

#### 3.1，对RISC-V处理器的研究

​		处理器的设计需要考虑如下问题：

1. 所支持的指令集。这代表了该处理器能够完成的功能范围，并包含了对于指令执行通路的需求
2. 组成执行通路的组件。包括算术逻辑单元(ALU)，程序计数器(PC)，寄存器组，缓存和存储单元等
3. 指令的处理方式。包括控制信号，时钟周期，指令流水线等，以及由此衍生出的任务调度、中断/陷入/异常问题的处理、数据同步等问题
4. 对于多核心处理器，还应考虑核心结构（同构或异构）、核间通信等方面的问题

​		根据应用场景的不同，RISC-V处理器可以划分为通用处理器、嵌入式处理器、教学研究用处理器。

​		通用处理器不针对特定应用场景，因此将支持最全的指令集和最多的功能；嵌入式处理器特别考虑了资源受限的嵌入式环境，往往需要支持E扩展或C扩展以优化尺寸权衡面积和性能需求；教学研究用处理器通常采用最精简的设计，只包含最基本的、必要的功能以清晰的表现处理器的工作流程。

#### 3.2，对RISC-V模拟器的研究

​		QEMU模拟器。

---

### 4，RISC-V系统设计

#### 4.1，RISC-V系统功能实现

​		根据所含处理器核心的数目和组织形式的不同，RISC-V系统可分为单处理器系统、多处理器系统、处理器集群系统。

##### 4.1.1，单处理器系统

​		系统设计环节：

1. 指令集与微架构的设计与实现
2. 体系研究与性能建模
3. 高层次综合（HLS）或寄存器传输级（RTL）实现
4. RTL验证
5. 关键速度相关部件（缓存、寄存器、算数逻辑单元）电路设计
6. 逻辑综合
7. 时序分析
8. 物理设计，包括布局、布线、版图设计
9. 检查RTL、逻辑门层、晶体管层及物理层表示相符
10. 检查信号完整性、芯片可制造性

##### 4.1.2，多处理器系统

​		在单处理器系统的基础上，更需关心处理器核心增加带来的核间管理与通信问题，关注数据的并行或并发处理能力。具体面临以下挑战：

1. 存储一致性与缓存共享问题
2. RTL电路大幅增长带来的复杂性问题
3. 组件依赖性问题
4. 通信延迟问题

##### 4.1.3，处理器集群系统

#### 4.2，RISC-V系统性能优化

​		主要的优化需求集中在处理器、内存、通信、能耗这四个方面。

##### 4.2.1，处理器利用率提升

​		处理器的利用率反映了处理器有效工作时间在总运行时间中的占比，是一项描述处理器繁忙程度的指标。减少处理器空闲等待时间，提升处理器利用率。

​		“冯·诺依曼瓶颈”是影响CPU利用率的一类典型问题，在冯·诺依曼结构的计算机系统中，指令与数据被不加区分地存放在内存，使得取指令和取数据不能同时进行，否则将引起访存混乱。CPU在执行运算前后，都需要额外的时间等待数据完成存取，而不能一直处于工作状态，因此此结构的CPU存在一个相对较低的利用率上线。

​		在2017年，包云岗等人提出一种标签化冯·诺依曼体系结构LvNA。

​		在2021年，Schuiki等人提出了一种轻量级的RISC-V扩展"流语义寄存器（SSR）"。

##### 4.2.2，内存优化

​		内存的设计直接制约着系统整体的组织形式和工作方式，在数据存储、通信、同步、处理效率等多方面都对系统有关键性的影响。

​		例如，多核处理器中，随着芯片上核心数量的增加，会出现“缓存行乒乓问题”，即当多个CPU共享同一缓存行中的变量时，不同CPU对该变量的频繁读写会导致其他CPU的缓存行频繁失效。2019年，正对上述问题，Dogan提出了一种针对数据的硬件内移动计算（MC）模型。

​		扩展基全局地址空间（xBGAS）是2018年Leidel等人为了解决可扩展的高性能计算机架构在操作离开单个设备域时常常遭遇不必要的延迟的问题，所提出的一种RISC-V指令集微架构扩展。

##### 4.2.3，通信延迟缓解

​		通信时连接系统各组件、各成分之间的信息交换过程，通信延迟将推迟目标获得所需信息的时间，从而增大其空闲等待时间，造成整体用时延长，目标利用率低，或者能量空耗。缓解通信延迟，除了相关硬件制作工艺的改进外，提升系统的并行能力、掩盖通信延迟的不利影响也是可行做法。

​		2019年,Morais等人提出一种将任务调度加速器与通用CPU紧密集成的体系结构，以减少通信延迟及运行开销，从而提高与任务调度并行的应用程序的性能。

##### 4.2.4，能耗优化

​		能耗优化依赖于对系统负载结构的整体设计，现有研究主要集中在功率控制、电源能效优化等方面。

​		关于功率控制，2019年Zhou等人介绍了一种基于学习的架构PRIMAL；2020年，Banbini等人基于RISC-V核心的并行超低功耗控制，提出一种开源功率控制器系统（PCS）设计方案。

​		在电源的能源效率提升方面，Wright等人于2020年设计了一种双核RISC-V处理器，实现了一个完全集成的、片上的、高密度的、由开关电容DCDC转换器供电的细粒度电压域系统。

#### 4.3，RISC-V系统安全策略设计

​		根据安全威胁发生的主要渠道，将系统可能遭受到的安全威胁归纳如下三方面：

1. 硬件微架构攻击

​		这类攻击通过侵入系统所依赖的硬件微架构并将攻击代码注入底层硬件造成系统功能的偏差或失效。

2. 内存攻击

​		这类攻击以干扰或破坏内存功能为主要手段。在众多的内存攻击中，程序控制流劫持攻击是较为常见和重要的一种攻击类型，这类攻击通常会制造和利用内存损坏，然后将控制流重定向至攻击者指定的内存位置，使程序脱离正常执行流程，按攻击者的意图执行。

3. 侧信道攻击（SCA）

​		这类攻击往往从外部发起，围绕构成系统的硬件设备的物理特征或电气特性实施，意图通过测量、统计、物理观察等手段推测和获取系统敏感信息，造成信息泄露。

​		针对上述安全威胁，学术界和工业界提出了许多安全策略：

​		（1）引入安全硬件，将软件安全威胁转移到硬件层面解决

​		（2）模糊易攻击的敏感信息，增大攻击者搜索和获取敏感信息的时间或技术成本

​		（3）保护信息流完整性，保障程序执行安全

​		（4）设置配套验证机制，及时发现攻击行为

​		（5）必要时采用冗余设计，增加系统容错性，减少对特定设备的依赖

##### 4.3.1，硬件微架构攻击的防御

​		硬件的生存周期较长，通常需要经过多次微代码更新来解决安全或功能性问题，因此设计在引入一定的灵活性的同时，也留给了恶意攻击侵入的空间。

​		应对硬件微架构攻击可以从供应链安全和微架构安全两个方面着手。

##### 4.3.2，程序劫持攻击的防御

​		控制流完整性时应对程序劫持攻击的主要技术措施，核心是为程序构造对应的控制流图，并保证在程序执行过程中严格遵守控制流图。

##### 4.3.3，测信道攻击的防御

​		此类攻击是指攻击者从系统的物理实现出发，通过测量、统计、物理观察等手段推测和获取系统敏感信息的攻击手段。

##### 4.3.4，安全策略总结

![image-20230703092637175](C:\Users\张云鑫\AppData\Roaming\Typora\typora-user-images\image-20230703092637175.png)

### 5，RISC-V应用场景分析

#### 5.1，RAE：一种远程原子扩展

##### 5.1.1，场景描述

​		在新兴的数据密集型应用的推动下，HPC（high performance computing）系统的结构逐渐复杂化，大量数据集被映射到离散的节点中，以实现分布式存储和计算，这种是数据分布将导致频繁的跨节点数据事物，造成了大量开销。

> [(29条消息) 什么是原子操作_辽宁大学的博客-CSDN博客](https://blog.csdn.net/zhuiyunzhugang/article/details/108147466?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-108147466-blog-50275471.235^v38^pc_relevant_yljh&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-108147466-blog-50275471.235^v38^pc_relevant_yljh&utm_relevant_index=2)

##### 5.1.2，场景分析

​		对于指令集自身的扩展研究需要考虑如下问题：

1. 工作场景或功能目标
2. 各指令的功能、格式信息
3. 实现的可行性

#### 5.2，SALSA：一个用于序列比对的领域专用架构

#### 5.3，MAC：3D栈内存聚合单元

#### 5.4，Notary安全批准方案

### 6，未来发展方向

#### 6.1，硬件新发展

​		随着社会需求的不断增长和相关技术的不断进步，会不断涌现出各种新类型硬件。如何适应新的工作环境，适配这些新的硬件，继续保持RISC-V系统的功能完整性，性能优越性，安全稳定性值得关注；随着新硬件的产生，新的安全问题也会随着出现，如何解决这些问题也同样是新的工作方向。

#### 6.2，与新技术结合

​		可以与新技术结合，在功能、性能、安全等领域实现新的突破。

